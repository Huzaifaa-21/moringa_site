<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pure Moringa | Premium Organic Moringa Powder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    {% if PLAUSIBLE_DOMAIN %}
    <script defer data-domain="{{ PLAUSIBLE_DOMAIN }}" src="https://plausible.io/js/plausible.js"></script>
    {% endif %}
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <img src="{{ url_for('images', filename='logo.png') }}" alt="Pure Moringa Logo" class="logo-image">
                <h1>Pure Moringa</h1>
            </div>
            <div class="menu-toggle" role="button" aria-label="Toggle navigation menu" aria-controls="nav" aria-expanded="false" tabindex="0">
                <i class="fas fa-bars" aria-hidden="true"></i>
            </div>
            <nav id="nav" aria-label="Main navigation">
                <ul role="menubar">
                    <li role="none"><a href="#" class="nav-link" role="menuitem" data-page="home">Home</a></li>
                    <li role="none"><a href="#" class="nav-link" role="menuitem" data-page="about">About</a></li>
                    <li role="none"><a href="#" class="nav-link" role="menuitem" data-page="order">Order</a></li>
                    <li role="none"><a href="#" class="nav-link" role="menuitem" data-page="contact">Contact</a></li>
                    {% if session.get('customer_id') %}
                    <li role="none"><a href="{{ url_for('customer_dashboard') }}">Dashboard</a></li>
                    <li role="none"><a href="{{ url_for('customer_logout') }}">Logout</a></li>
                    {% else %}
                    <li role="none"><a href="{{ url_for('customer_login') }}">Login</a></li>
                    <li role="none"><a href="{{ url_for('customer_register') }}">Register</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <!-- Home Page -->
    <div id="home" class="page active">
        <!-- Hero Section -->
        <section class="hero">
            <div class="container hero-content">
                <h2>Premium Moringa Powder for Optimal Wellness</h2>
                <p>100% Pure, Organic, and Chemical-Free Moringa Powder sourced from the rich farms of Bundelkhand</p>
                <a href="#" class="btn nav-link" data-page="order">Order Now</a>
            </div>
        </section>

        <!-- About Preview Section -->
        <section class="about-preview">
            <div class="container">
                <div class="section-title">
                    <h2>The Miracle Tree</h2>
                    <p>Discover the incredible health benefits of Moringa Oleifera</p>
                </div>
                <div class="about-content">
                    <div class="about-text">
                        <p>Welcome to the world of wellness with our premium Moringa Powder, a powerful natural supplement sourced directly from the rich, organic farms of Bundelkhand, South Uttar Pradesh. Known as the "Miracle Tree," Moringa oleifera is a treasure trove of essential nutrients and antioxidants, revered in Ayurveda and modern health science for its remarkable health benefits.</p>
                        <p>Our Moringa Powder is 100% pure, organic, and chemical-free, cultivated using sustainable farming methods in the fertile soils of rural Bundelkhand. Each leaf is handpicked at peak freshness and carefully shade-dried to retain maximum nutrition, then finely ground into a vibrant green powder that's easy to consume and full of life.</p>
                        <a href="#" class="btn nav-link" data-page="about">Learn More</a>
                    </div>
                    <div class="about-image">
                        <img src="{{ url_for('images', filename='img1.png') }}" alt="Moringa Powder">
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features">
            <div class="container">
                <div class="section-title">
                    <h2>Why Choose Our Moringa Powder?</h2>
                    <p>Experience the numerous health benefits of our premium product</p>
                </div>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <h3>Pure & Organic</h3>
                        <p>Sourced from local farms using no pesticides or harmful chemicals. Certified for purity and safety.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-vitamins"></i>
                        </div>
                        <h3>Nutrient-Rich</h3>
                        <p>Packed with vitamins A, C, E, K, and a complete range of B-vitamins, along with iron, calcium, magnesium, potassium, and plant based protein.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Immunity Booster</h3>
                        <p>High in antioxidants and anti-inflammatory compounds, it helps strengthen your body's natural defense system.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Usage Section -->
        <section class="usage">
            <div class="container">
                <div class="section-title">
                    <h2>How to Use Moringa Powder</h2>
                    <p>Incorporating Moringa Powder into your daily routine is simple and effective</p>
                </div>
                <div class="usage-content">
                    <div class="usage-item">
                        <h3>Moringa Drink</h3>
                        <p>Mix 1 teaspoon of Moringa powder in warm water or lemon water on an empty stomach.</p>
                    </div>
                    <div class="usage-item">
                        <h3>Smoothies & Juices</h3>
                        <p>Add to fruit smoothies, vegetable juices, or protein shakes for a nutritious boost.</p>
                    </div>
                    <div class="usage-item">
                        <h3>Sprinkle on Food</h3>
                        <p>Use as a seasoning over soups, dals, rice, or salads. Just a small pinch can go a long way.</p>
                    </div>
                    <div class="usage-item">
                        <h3>Baking & Cooking</h3>
                        <p>Add to your roti dough, pancake batter, or baked goods for a green twist.</p>
                    </div>
                    <div class="usage-item">
                        <h3>Face Pack (optional use)</h3>
                        <p>Mix with honey or yogurt and apply as a natural face pack for glowing skin.</p>
                    </div>
                    <div class="usage-item">
                        <h3>Recommended Dosage</h3>
                        <p>Start with half to one teaspoon per day, and gradually increase to 1–2 teaspoons based on your body's response.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section class="gallery">
            <div class="container">
                <div class="section-title">
                    <h2>Product Gallery</h2>
                    <p>See our premium Moringa products</p>
                </div>
                <div class="gallery-grid">
                    <div class="gallery-item">
                        <img src="{{ url_for('images', filename='img3.png') }}" alt="Moringa Product Image 1">
                    </div>
                    <div class="gallery-item">
                        <img src="{{ url_for('images', filename='img4.png') }}" alt="Moringa Product Image 2">
                    </div>
                    <div class="gallery-item">
                        <img src="{{ url_for('images', filename='img5.png') }}" alt="Moringa Product Image 3">
                    </div>
                    <div class="gallery-item">
                        <img src="{{ url_for('images', filename='img6.png') }}" alt="Moringa Product Image 4">
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- About Page -->
    <div id="about" class="page">
        <section class="about-detailed">
            <div class="container">
                <div class="section-title">
                    <h2>About Our Moringa Powder</h2>
                    <p>Learn about our sourcing, process, and commitment to quality</p>
                </div>
                <div class="about-content">
                    <div class="about-text">
                        <p>Our Moringa Powder is sourced directly from the rich, organic farms of Bundelkhand, South Uttar Pradesh. This region is known for its fertile soil and ideal climate for growing Moringa trees, which are often called the "Miracle Tree" due to their incredible nutritional value.</p>
                        <p>We work directly with local farmers who use sustainable farming practices, ensuring that our Moringa is grown without pesticides or harmful chemicals. Each leaf is handpicked at peak freshness to guarantee the highest nutrient content.</p>
                        <p>After harvesting, the leaves are carefully shade-dried to preserve their nutritional value and vibrant green color. They are then finely ground into a powder that retains all the natural goodness of the fresh leaves.</p>
                        <p>With rising concerns over immunity and well-being, our Moringa Powder is a daily dose of vitality for people of all ages. It's not just a supplement – it's a commitment to clean living, traditional wisdom, and better health.</p>
                    </div>
                    <div class="about-image">
                        <img src="{{ url_for('images', filename='about.png') }}" alt="Moringa Farming">
                    </div>
                </div>
            </div>
        </section>

        <section class="features">
            <div class="container">
                <div class="section-title">
                    <h2>Health Benefits</h2>
                    <p>Why Moringa is considered a superfood</p>
                </div>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3>Mental Clarity & Energy</h3>
                        <p>Enhances focus, reduces fatigue, and improves overall energy levels without caffeine.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <h3>Diabetic & Heart-Friendly</h3>
                        <p>Helps regulate blood sugar levels and supports cardiovascular health.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-stomach"></i>
                        </div>
                        <h3>Supports Digestion</h3>
                        <p>Rich in fiber and detoxifying compounds to promote healthy gut and metabolism.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-spa"></i>
                        </div>
                        <h3>Good for Skin & Hair</h3>
                        <p>Antioxidants nourish skin from within and promote stronger, shinier hair.</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Order Page -->
    <div id="order" class="page">
        <section class="product">
            <div class="container">
                <div class="section-title">
                    <h2>Order Moringa Powder</h2>
                    <p>Get your supply of premium organic Moringa Powder delivered to your doorstep</p>
                </div>
                <div class="product-content">
                    <div class="product-image">
                        <img src="{{ url_for('images', filename='img2.png') }}" alt="Moringa Powder Product">
                    </div>
                    <h3>Premium Organic Moringa Powder</h3>
                    <p>100% pure, chemical-free Moringa powder sourced from organic farms in Bundelkhand, South Uttar Pradesh. Packed with essential nutrients and antioxidants for optimal health.</p>
                    <div class="price">₹499 / 200g pouch</div>
                    <div class="shipping-info">
                        <p><i class="fas fa-truck"></i> Free shipping on orders of 3+ pouches</p>
                        <p><i class="fas fa-shield-alt"></i> Secure payment with Razorpay</p>
                        <p><i class="fas fa-clock"></i> Estimated delivery: 3–5 business days</p>
                        <p><i class="fas fa-undo"></i> Hassle-free returns within 7 days if unopened</p>
                    </div>

                    {% if not session.get('customer_id') %}
                    <div class="login-prompt" style="margin: 1rem 0; padding: 0.75rem 1rem; background:#f0f7ff; border:1px solid #cfe4ff; border-radius:8px;">
                        Returning customer? <a href="{{ url_for('customer_login') }}" class="btn btn-secondary" style="margin-left:0.5rem;">Log in</a>
                        <span style="margin:0 0.5rem;">or</span>
                        <a href="{{ url_for('customer_register') }}" class="btn btn-secondary">Create an account</a>
                        <span style="display:block; margin-top:0.5rem; color:#555;">Creating an account lets you track your orders and download receipts anytime.</span>
                    </div>
                    {% endif %}

                    <form id="order-form">
                        <div class="form-section">
                            <div class="section-heading">Order Details</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quantity">Quantity:</label>
                                    <select id="quantity" name="quantity" onchange="updateTotal()">
                                        <option value="1">1 Pouch (200g) - ₹549</option>
                                        <option value="2">2 Pouches (400g) - ₹1048</option>
                                        <option value="3">3 Pouches (600g) - ₹1497 (Free Shipping)</option>
                                        <option value="5">5 Pouches (1kg) - ₹2495 (Free Shipping)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Total:</label>
                                    <div class="total-amount" aria-live="polite">
                                        <h4><span id="total-display">₹549</span></h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-heading">Customer Information</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name">Full Name:</label>
                                    <input type="text" id="name" name="name" required autocomplete="name">
                                </div>
                                <div class="form-group">
                                    <label for="email">Email:</label>
                                    <input type="email" id="email" name="email" required autocomplete="email">
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone:</label>
                                    <input type="tel" id="phone" name="phone" required autocomplete="tel" inputmode="numeric" pattern="\d{10}" maxlength="10">
                                </div>
                                <div class="form-group">
                                    <label for="pincode">Pincode:</label>
                                    <input type="text" id="pincode" name="pincode" required inputmode="numeric" pattern="\d{6}" maxlength="6">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="address">Shipping Address:</label>
                                <textarea id="address" name="address" required autocomplete="shipping address-line1"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-section" aria-describedby="checkout-info">
                            <div id="checkout-info" class="section-heading" style="display:flex; align-items:center; gap:12px;">
                                <span>Checkout</span>
                            </div>
                            <p style="margin:10px 0; color:#444;">
                                <i class="fas fa-clock"></i> Estimated delivery: 3–5 business days. 
                                <i class="fas fa-undo" style="margin-left:10px;"></i> Hassle-free returns within 7 days if unopened.
                            </p>
                            <button type="submit" class="btn">
                                <i class="fas fa-credit-card"></i> Pay with Razorpay
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <!-- Contact Page -->
    <div id="contact" class="page">
        <section class="contact">
            <div class="container">
                <div class="section-title">
                    <h2>Contact Us</h2>
                    <p>Get in touch with us for any questions or inquiries</p>
                </div>
                <div class="contact-content">
                    <div class="contact-info">
                        <h3>Get In Touch</h3>
                        <p>We'd love to hear from you. Whether you have questions about our Moringa powder, want to know more about our farming practices, or need assistance with an order, we're here to help.</p>
                        <div class="contact-details">
                            <p><i class="fas fa-map-marker-alt"></i> Bundelkhand, South Uttar Pradesh, India</p>
                            <p><i class="fas fa-phone"></i> +91 98765 43210</p>
                            <p><i class="fas fa-envelope"></i> info@puremoringa.com</p>
                        </div>
                    </div>
                    <div class="contact-form">
                        <h3>Send us a Message</h3>
                        <form id="contact-form">
                            <div class="form-group">
                                <label for="contact-name">Your Name:</label>
                                <input type="text" id="contact-name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="contact-email">Email:</label>
                                <input type="email" id="contact-email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="contact-subject">Subject:</label>
                                <input type="text" id="contact-subject" name="subject" required>
                            </div>
                            <div class="form-group">
                                <label for="contact-message">Message:</label>
                                <textarea id="contact-message" name="message" required></textarea>
                            </div>
                            <button type="submit" class="btn">Send Message</button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>About Us</h3>
                    <p>We provide premium quality Moringa powder sourced directly from organic farms in Bundelkhand, South Uttar Pradesh. Our mission is to bring the incredible health benefits of Moringa to everyone.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#" class="nav-link" data-page="home">Home</a></li>
                        <li><a href="#" class="nav-link" data-page="about">About</a></li>
                        <li><a href="#" class="nav-link" data-page="order">Order</a></li>
                        <li><a href="#" class="nav-link" data-page="contact">Contact</a></li>
                        {% if session.get('customer_id') %}
                        <li><a href="{{ url_for('customer_dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('customer_logout') }}">Logout</a></li>
                        {% else %}
                        <li><a href="{{ url_for('customer_login') }}">Login</a></li>
                        <li><a href="{{ url_for('customer_register') }}">Register</a></li>
                        {% endif %}
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Info</h3>
                    <p><i class="fas fa-map-marker-alt"></i> Bundelkhand, South Uttar Pradesh, India</p>
                    <p><i class="fas fa-phone"></i> +91 98765 43210</p>
                    <p><i class="fas fa-envelope"></i> info@puremoringa.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Pure Moringa. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        // Simple page navigation
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const menuToggle = document.querySelector('.menu-toggle');
            const nav = document.getElementById('nav');
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrf_token='))?.split('=')[1];
            
            // Notification helper
            function showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) return;
                const note = document.createElement('div');
                note.className = `notification ${type}`;
                note.textContent = message;
                container.appendChild(note);
                // Animate in
                requestAnimationFrame(() => note.classList.add('show'));
                // Auto dismiss
                setTimeout(() => {
                    note.classList.remove('show');
                    setTimeout(() => {
                        if (note.parentNode === container) {
                            container.removeChild(note);
                        }
                    }, 300);
                }, 3000);
            }
            
            // Toggle mobile menu
            function toggleMenu(){
                const expanded = menuToggle.getAttribute('aria-expanded') === 'true';
                menuToggle.setAttribute('aria-expanded', (!expanded).toString());
                nav.classList.toggle('active');
            }
            menuToggle.addEventListener('click', toggleMenu);
            menuToggle.addEventListener('keydown', function(e){
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleMenu();
                }
            });
            
            // Handle navigation
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    
                    if (targetPage) {
                        // Hide all pages
                        pages.forEach(page => {
                            page.classList.remove('active');
                        });
                        
                        // Show target page
                        document.getElementById(targetPage).classList.add('active');
                        
                        // Close mobile menu if open
                        nav.classList.remove('active');
                        menuToggle.setAttribute('aria-expanded', 'false');
                        
                        // Scroll to top
                        window.scrollTo(0, 0);
                    }
                });
            });
            
            // Update total amount based on quantity
            window.updateTotal = function() {
                const quantity = parseInt(document.getElementById('quantity').value);
                const basePrice = 499;
                const shipping = quantity >= 3 ? 0 : 50;
                const total = (basePrice * quantity) + shipping;
                document.getElementById('total-display').textContent = `₹${total}`;
            };
            
            // Initialize total
            updateTotal();
            
            function track(eventName, props = {}){
                try { window.plausible && window.plausible(eventName, { props }); } catch(e) {}
            }
            
            // Payment processing
            document.getElementById('order-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    pincode: document.getElementById('pincode').value,
                    quantity: document.getElementById('quantity').value
                };
                
                // Validate form
                if (!formData.name || !formData.email || !formData.phone || !formData.address || !formData.pincode) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                // Show loading
                const submitBtn = document.querySelector('#order-form button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitBtn.disabled = true;
                
                // Create order
                fetch('/api/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    track('order-create', { order_id: data.order_id, amount: data.amount });
                    
                    // Initialize Razorpay
                    const options = {
                        key: data.key,
                        amount: data.amount * 100,
                        currency: data.currency,
                        name: data.name,
                        description: data.description,
                        order_id: data.order_id,
                        prefill: data.prefill,
                        theme: {
                            color: '#2e7d32'
                        },
                        handler: function(response) {
                            // Inline payment verification to avoid undefined function
                            fetch('/api/verify-payment', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) },
                                body: JSON.stringify({
                                    razorpay_order_id: options.order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature
                                })
                            })
                            .then(res => res.json())
                            .then(result => {
                                if (result.status === 'success') {
                                    track('payment-success', { order_id: result.order_id });
                                    showNotification('Payment successful! Generating receipt...', 'success');
                                    // Re-enable submit button
                                    submitBtn.innerHTML = originalText;
                                    submitBtn.disabled = false;
                                    // Open receipt in new tab
                                    const url = `/api/generate-receipt/${result.order_id}`;
                                    window.open(url, '_blank');
                                    track('receipt-opened', { order_id: result.order_id });
                                    
                                    // Email receipt
                                    fetch('/api/send-receipt', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) },
                                        body: JSON.stringify({ order_id: result.order_id, email: formData.email })
                                    }).catch(() => {});
                                } else {
                                    showNotification(result.error || 'Payment verification failed', 'error');
                                    submitBtn.innerHTML = originalText;
                                    submitBtn.disabled = false;
                                }
                            })
                            .catch(err => {
                                showNotification('Payment verification failed: ' + err.message, 'error');
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                                track('payment-failed', { reason: err.message });
                            });
                        },
                        modal: {
                            ondismiss: function() {
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                                showNotification('Payment cancelled', 'error');
                                track('payment-failed', { reason: 'modal-dismiss' });
                                try {
                                    fetch('/api/payment-cancel', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) },
                                        body: JSON.stringify({
                                            razorpay_order_id: options.order_id,
                                            reason: 'Razorpay modal dismissed'
                                        })
                                    }).catch(() => {});
                                } catch (e) {}
                            }
                        }
                    };

                    // Launch Razorpay Checkout and capture failure events (with guards)
                    if (!window.Razorpay) {
                        showNotification('Payment library failed to load. Please check your connection and try again.', 'error');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                    if (!options.key || !options.order_id) {
                        showNotification('Payment initialization failed. Missing configuration.', 'error');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                    try {
                        const rzp = new Razorpay(options);
                        rzp.on('payment.failed', function (response) {
                            showNotification('Payment failed: ' + (response.error && response.error.description || 'Unknown error'), 'error');
                            track('payment-failed', { reason: response.error && response.error.description || 'Unknown error' });
                            try {
                                fetch('/api/payment-cancel', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) },
                                    body: JSON.stringify({
                                        razorpay_order_id: options.order_id,
                                        reason: 'Payment failed: ' + (response.error && response.error.description || 'Unknown error')
                                    })
                                }).catch(() => {});
                            } catch (e) {}
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        });
                        rzp.open();
                    } catch (e) {
                        showNotification('Unable to open payment: ' + (e && e.message ? e.message : 'Unknown error'), 'error');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                }) // end fetch .then(data => { ... })
                .catch(err => {
                    showNotification('Unable to initiate payment: ' + (err && err.message ? err.message : 'Unknown error'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
            }); // end submit handler
        }); // end DOMContentLoaded
    </script>